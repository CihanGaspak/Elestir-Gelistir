<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profil | EleÅŸtir-GeliÅŸtir</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://kit.fontawesome.com/3e9484d64b.js" crossorigin="anonymous"></script>
  <style>

    .post-actions {
  display: flex;
  gap: 15px;
  margin-top: 10px;
  padding: 0 10px;
}
.post-actions span {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 15px;
  color: #444;
}
.post-actions i {
  color: #444;
}

    /* KÄ±saltÄ±lmÄ±ÅŸ stiller - seninle aynÄ± */
    .post-card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); max-width: 750px; }
    .post-header { display: flex; align-items: center; }
    .post-header .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .post-actions { display: flex; gap: 15px; margin-top: 10px; }
    .step-section { margin-top: 10px; }
    .step-title { font-weight: bold; margin-top: 10px; }
    .step-body { padding-left: 10px; color: #555; }
    .profile-texts {
  display: flex;
  flex-direction: column;
  justify-content: center;
  color: #222;
}

.profile-texts p {
  margin: 4px 0;
}

.profile-texts .stats {
  display: flex;
  gap: 20px;
  margin-top: 8px;
  font-size: 15px;
}

.profile-texts .stats div {
  text-align: center;
}
.bio-text {
  margin-top: 6px;
  font-size: 15px;
  color: #111;
}

.stats.clickable-stats div {
  cursor: pointer;
  transition: color 0.2s;
  text-align: center;
}

.stats.clickable-stats div:hover {
  color: #ffa726;
}
/* Profil DÃ¼zenle ve Ã‡Ä±kÄ±ÅŸ Yap butonlarÄ± iÃ§in stil */
.profile-header {
  display: flex;
  align-items: center;
  padding: 20px;
  background: white;
  border-radius: 16px;
  margin: 20px auto;
  max-width: 700px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  justify-content: space-between; /* ButonlarÄ± saÄŸa iter */
}

.profile-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.profile-actions button {
  padding: 8px 20px;
  border-radius: 20px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.profile-actions .profile-edit-btn {
  background-color: #4CAF50;
  color: white;
}

.profile-actions .profile-edit-btn:hover {
  background-color: #45a040;
}

.profile-actions .profile-logout-btn {
  background-color: #d32f2f;
  color: white;
}

.profile-actions .profile-logout-btn:hover {
  background-color: #c62828;
}


.profile-texts {
  display: flex;
  flex-direction: column;
  color: #222;
  flex-grow: 1;
}

.profile-texts h2 {
  font-size: 24px;
  margin: 0;
}

.profile-texts #profile-username {
  font-size: 16px;
  color: #666;
  margin: 4px 0 8px 0;
}

.profile-texts .bio-text {
  font-size: 15px;
  color: #333;
  margin-bottom: 12px;
  line-height: 1.4;
}

.stats {
  display: flex;
  gap: 20px;
  font-size: 15px;
}

.stats div {
  text-align: center;
}

.stats div strong {
  display: block;
  font-size: 18px;
  color: #ffa726;
}

.stats div span {
  color: #555;
  font-weight: 500;
}

.stats div:hover {
  color: #ffa726;
  cursor: pointer;
}


.posts-wrapper {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  padding: 20px;
  max-width: 700px;
  margin: 20px auto; /* Ortalar */
}
.posts-title-wrapper {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  padding: 20px;
  max-width: 700px;
  margin: 20px auto;
  text-align: center;
}

.posts-title-wrapper h3 {
  margin: 0;
  display: center; /* garantili merkezlenme */
  font-size: 22px;
  font-weight: 600;
  color: #333;
}

#posts-container {
  max-width: 700px;
  margin: 20px auto; /* Ortalar */
}

.profile-actions button {
  padding: 8px 20px;
  border-radius: 999px;
  border: 1px solid transparent;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.custom-btn {
  padding: 8px 20px;
  border-radius: 999px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  border: none;
  color: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  transition: background-color 0.3s ease;
}

/* Renk sÄ±nÄ±flarÄ± */
.btn-orange {
  background-color: #fb8c00;
}
.btn-orange:hover {
  background-color: #e67c00;
}

.btn-red {
  background-color: #d32f2f;
}
.btn-red:hover {
  background-color: #b71c1c;
}

.btn-grey {
  background-color: #e0e0e0;
  color: black;
}
.btn-grey:hover {
  background-color: #bdbdbd;
}


  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="profile-header">
  <img src="assets/avatars/avatar1.png" class="avatar" alt="Avatar" />
  <div class="profile-texts">
    <h2 id="profile-name">Cihan Gaspak</h2>
    <p id="profile-username">@ilimbeser</p>
    <p id="profile-bio" class="bio-text">Bunca yÄ±l sÃ¶nmemiÅŸ umudum<br>Nisan deÄŸilse MayÄ±s, PerÅŸembe deÄŸilse Pazar</p>

    <div class="stats clickable-stats">
  <div class="stat-item" data-type="followers">
    <strong id="followers-count">0</strong><br><span>TakipÃ§i</span>
  </div>
  <div class="stat-item" data-type="following">
    <strong id="following-count">0</strong><br><span>Takip</span>
  </div>
  <div>
    <strong id="usefulness-score">0/10</strong><br><span>FaydalÄ±lÄ±k</span>
  </div>
  <div>
    <strong id="posts-count">0</strong><br><span>Post</span>
  </div>
</div>

  </div>

  <!-- Butonlar saÄŸda -->
  <div class="profile-actions" id="profile-actions"></div>
</div>


  
  <div class="posts-title-wrapper">
  <h3>GÃ¶nderiler</h3>
</div>
<div id="posts-container"></div>


    
  </div>


  <script type="module">
// âœ… Firebase ve auth tanÄ±mlarÄ± aynen kalsÄ±n
import { showProfileEditWidget } from './profileEdit.js';
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { doc, getDoc, collection, query, where, onSnapshot, updateDoc, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ðŸ”¥ Yeni sistem
let allPosts = [];

onAuthStateChanged(auth, async (user) => {
    const params = new URLSearchParams(window.location.search);
    const profileUid = params.get("uid") || user.uid;
    if (!profileUid) return;

    const userSnap = await getDoc(doc(db, "users", profileUid));
    if (userSnap.exists()) {
        const data = userSnap.data();
        document.querySelector(".profile-header img.avatar").src = data.photoUrl || 'assets/avatars/avatar1.png';
        document.getElementById("profile-name").textContent = data.username || "KullanÄ±cÄ±";
        document.getElementById("profile-username").textContent = `@${data.username || "kullanici"}`;
        document.getElementById("followers-count").textContent = data.followers?.length || 0;
        document.getElementById("following-count").textContent = data.following?.length || 0;
        document.getElementById("usefulness-score").textContent = data.usefulness || "0/10";
        const actionsContainer = document.getElementById("profile-actions");

         // ðŸ”¥ Tam burada butonlarÄ± ekle
        if (user.uid === profileUid) {
    const actionsContainer = document.getElementById("profile-actions");
    actionsContainer.innerHTML = `
      <button class="profile-edit-btn">Profili DÃ¼zenle</button>
      <button class="profile-logout-btn">Ã‡Ä±kÄ±ÅŸ Yap</button>
    `;

    document.querySelector(".profile-edit-btn").onclick = () => showProfileEditWidget({ uid: profileUid, username: data.username });
    document.querySelector(".profile-logout-btn").onclick = () => auth.signOut().then(() => window.location.href = "login.html");
}

if (user.uid === profileUid) {
  // âœ… Kendi profilin: dÃ¼zenle ve Ã§Ä±kÄ±ÅŸ
  actionsContainer.innerHTML = `
    <button class="profile-edit-btn">Profili DÃ¼zenle</button>
    <button class="profile-logout-btn">Ã‡Ä±kÄ±ÅŸ Yap</button>
  `;
  document.querySelector(".profile-edit-btn").onclick = () => showProfileEditWidget({ uid: profileUid, username: data.username });
  document.querySelector(".profile-logout-btn").onclick = () => auth.signOut().then(() => window.location.href = "login.html");

} else {
  // âœ… BaÅŸkasÄ±nÄ±n profili
  const isFollowing = data.followers?.includes(user.uid);
  const followsMe = data.following?.includes(user.uid);

  actionsContainer.innerHTML = `
  <button class="custom-btn ${isFollowing ? "btn-grey" : "btn-orange"} follow-toggle-btn" id="follow-btn">
    ${isFollowing ? "Takipten Ã‡Ä±k" : "Takip Et"}
  </button>
  ${followsMe ? `<button class="custom-btn btn-red" id="remove-follower-btn">TakipÃ§iden Ã‡Ä±kar</button>` : ""}
`;




  // Takip et / takipten Ã§Ä±k
  document.getElementById("follow-btn").onclick = async () => {
    const currentRef = doc(db, "users", user.uid);
    const targetRef = doc(db, "users", profileUid);

    if (isFollowing) {
      await updateDoc(currentRef, { following: arrayRemove(profileUid) });
      await updateDoc(targetRef, { followers: arrayRemove(user.uid) });
    } else {
      await updateDoc(currentRef, { following: arrayUnion(profileUid) });
      await updateDoc(targetRef, { followers: arrayUnion(user.uid) });
    }
    location.reload(); // GÃ¼ncelle
  };

  // TakipÃ§iden Ã§Ä±kar
  if (followsMe) {
    document.getElementById("remove-follower-btn").onclick = async () => {
      const currentRef = doc(db, "users", user.uid);
      const targetRef = doc(db, "users", profileUid);

      await updateDoc(currentRef, { followers: arrayRemove(profileUid) });
      await updateDoc(targetRef, { following: arrayRemove(user.uid) });

      location.reload();
    };
  }
}


    }

    // âœ… Burada query'yi tanÄ±mla
    const q = query(collection(db, "posts"), where("authorId", "==", profileUid));

    // PostlarÄ± dinle ve post sayÄ±sÄ±nÄ± gÃ¼ncelle
    onSnapshot(q, (snapshot) => {
        allPosts = snapshot.docs.map(doc => ({
            docId: doc.id,
            data: doc.data()
        }));

        // âœ… DoÄŸru yerde post sayÄ±sÄ±nÄ± gÃ¼ncelle
        document.getElementById("posts-count").textContent = allPosts.length;

        renderPosts();
    });
});

function logoutUser() {
    auth.signOut().then(() => {
        window.location.href = "index.html";
    });
}

async function renderPosts() {
    const container = document.getElementById("posts-container");
    container.innerHTML = ""; // Ã–nce temizle

    for (const { docId, data } of allPosts) {
        const cardHTML = await generatePostHTML(data, docId, auth.currentUser.uid);
        const card = document.createElement('div');
        card.innerHTML = cardHTML;
        container.appendChild(card.firstElementChild);

        // Her karta etkileÅŸimleri baÄŸla
        attachPostEvents(docId, data);
    }
}


async function attachPostEvents(docId, data) {
    const cardContainer = document.getElementById(`post-card-${docId}`);
    if (!cardContainer) return;

    // BeÄŸeni event
    const likeBtn = cardContainer.querySelector(`#like-${docId}`);
    if (likeBtn) {
        likeBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const postRef = doc(db, "posts", docId);
            const docSnap = await getDoc(postRef);
            const post = docSnap.data();
            const isLiked = post.likedBy?.includes(auth.currentUser.uid);
            post.likedBy = isLiked ? post.likedBy.filter(u => u !== auth.currentUser.uid) : [...(post.likedBy || []), auth.currentUser.uid];
            post.likesCount = post.likedBy.length;
            await updateDoc(postRef, { likedBy: post.likedBy, likesCount: post.likesCount });

            const newHTML = document.createElement("div");
            newHTML.innerHTML = await generatePostHTML(post, docId, auth.currentUser.uid);
            cardContainer.replaceWith(newHTML.firstElementChild);
            await attachPostEvents(docId, post);
        });
    }

    // Kaydet event
    const saveBtn = cardContainer.querySelector(`#save-${docId}`);
    if (saveBtn) {
        saveBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const postRef = doc(db, "posts", docId);
            const docSnap = await getDoc(postRef);
            const post = docSnap.data();
            const isSaved = post.savedBy?.includes(auth.currentUser.uid);
            post.savedBy = isSaved ? post.savedBy.filter(u => u !== auth.currentUser.uid) : [...(post.savedBy || []), auth.currentUser.uid];
            await updateDoc(postRef, { savedBy: post.savedBy });

            const newHTML = document.createElement("div");
            newHTML.innerHTML = await generatePostHTML(post, docId, auth.currentUser.uid);
            cardContainer.replaceWith(newHTML.firstElementChild);
            await attachPostEvents(docId, post);
        });
    }
}


// ðŸ”¥ generatePostHTML fonksiyonu index.html'dekiyle aynÄ± (gerekirse sana kopyasÄ±nÄ± da vereyim)
async function generatePostHTML(post, docId, uid) {
  // KullanÄ±cÄ± verisini Firestore'dan al
  let authorData = { username: "KullanÄ±cÄ±", photoUrl: "assets/avatars/avatar1.png" };
  try {
    const userSnap = await getDoc(doc(db, "users", post.authorId));
    if (userSnap.exists()) {
      authorData = userSnap.data();
    }
  } catch (e) {
    console.error("KullanÄ±cÄ± verisi alÄ±namadÄ±:", e);
  }

  const isLiked = post.likedBy?.includes(uid);
const likeIconClass = isLiked ? 'fas' : 'far';
const likeColor = isLiked ? 'orange' : 'black';


  const isSaved = post.savedBy?.includes(uid);
  const saveColor = isSaved ? 'orange' : 'black';
  const saveIconClass = isSaved ? 'fas' : 'far';

  const progress = post.progressStep ?? 0;
  const postDateObj = new Date(post.date?.seconds * 1000);
  const postDate = timeAgo(postDateObj);

  const progressIcons = [
    { icon: "fas fa-lightbulb", label: "Fikir" },
    { icon: "fas fa-tools", label: "Ã‡Ã¶zÃ¼m" },
    { icon: "fas fa-check-circle", label: "SonuÃ§" }
  ];

  const categoryIcons = {
    "EÄŸitim": "fas fa-school",
    "Spor": "fas fa-basketball-ball",
    "Teknoloji": "fas fa-microchip",
    "Tamirat": "fas fa-tools",
    "SaÄŸlÄ±k": "fas fa-heartbeat",
    "Sanat": "fas fa-palette",
    "YazÄ±lÄ±m": "fas fa-code",
    "KiÅŸisel GeliÅŸim": "fas fa-user-graduate",
    "AraÃ§ BakÄ±m": "fas fa-car",
    "DiÄŸer": "fas fa-ellipsis-h"
  };

  const progressHtml = progressIcons.map((step, index) => `
    <i class="${step.icon}" title="${step.label}"
      style="color:${index === 0 ? 'orange' : (progress >= index + 1 ? 'orange' : '#ccc')}; margin-right:6px;"></i>
  `).join('');

  const categoryHtml = `
    <i class="${categoryIcons[post.category] || categoryIcons['DiÄŸer']}" style="color:#666; margin-right:4px;"></i> ${post.category || 'DiÄŸer'}
  `;

  return `
    <div class="post-card" id="post-card-${docId}">
      <div onclick="goToPostDetail('${docId}')" style="cursor: pointer;">
        <div class="post-header">
          <img src="${authorData.photoUrl}" class="avatar" alt="Avatar">
          <div class="author-info">
            <p class="author-name">${authorData.username}</p>
             <p class="post-date">${timeAgo(new Date(post.date?.seconds * 1000))}</p>
          </div>
          <div style="margin-left:auto; text-align:right;">
            <div>${progressHtml}</div>
            <div style="font-size:12px; color:#555; margin-top:4px;">${categoryHtml}</div>
          </div>
        </div>
        <div class="post-content"><p>${post.content || ''}</p></div>
        <div class="step-section">
          <div class="step-title">ðŸ’¡ EleÅŸtir</div>
          <div class="step-body">${progress >= 1 ? (post.step1Note || 'HenÃ¼z not girilmemiÅŸ.') : 'HenÃ¼z bu aÅŸamaya geÃ§ilmedi.'}</div>
          <div class="step-title">ðŸ›  DÃ¼ÅŸÃ¼ndÃ¼r</div>
          <div class="step-body">${progress >= 2 ? (post.step2Note || 'HenÃ¼z not girilmemiÅŸ.') : 'HenÃ¼z bu aÅŸamaya geÃ§ilmedi.'}</div>
          <div class="step-title">âœ… GeliÅŸtir</div>
          <div class="step-body">${progress >= 3 ? (post.step3Note || 'HenÃ¼z not girilmemiÅŸ.') : 'HenÃ¼z bu aÅŸamaya geÃ§ilmedi.'}</div>
        </div>
      </div>

      <div class="post-actions">
        <span id="like-${docId}">
          <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up" style="color:${isLiked ? 'orange' : 'black'};"></i> ${post.likesCount || 0}
        </span>
        <span><i class="far fa-comment"></i> ${post.commentsCount || 0}</span>
        <span id="save-${docId}">
          <i class="${isSaved ? 'fas' : 'far'} fa-bookmark" style="color:${isSaved ? 'orange' : 'black'};"></i>
        </span>
        <span id="share-${docId}"><i class="fas fa-share"></i></span>
        <span><i class="far fa-eye"></i> ${post.views || 0}</span>
      </div>
    </div>
  `;
}

// ðŸ”¥ Eksik olan fonksiyonu ekle (index.html'dekiyle birebir aynÄ±sÄ±)
function timeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    let interval = Math.floor(seconds / 31536000);
    if (interval >= 1) return `${interval} yÄ±l Ã¶nce`;

    interval = Math.floor(seconds / 2592000);
    if (interval >= 1) return `${interval} ay Ã¶nce`;

    interval = Math.floor(seconds / 86400);
    if (interval >= 1) return `${interval} gÃ¼n Ã¶nce`;

    interval = Math.floor(seconds / 3600);
    if (interval >= 1) return `${interval} saat Ã¶nce`;

    interval = Math.floor(seconds / 60);
    if (interval >= 1) return `${interval} dakika Ã¶nce`;

    return "Az Ã¶nce";
}

const urlParams = new URLSearchParams(window.location.search);
const viewedUid = urlParams.get("uid");

document.querySelectorAll('.stat-item').forEach(item => {
  item.addEventListener('click', () => {
    const type = item.dataset.type; // 'followers' veya 'following'
    const uid = viewedUid || currentUserId; // hangisi varsa onu kullan

    if (uid && type) {
      window.location.href = `followers.html?uid=${uid}&type=${type}`;
    }
  });
});


</script>
<!-- Dinamik Navbar -->
  <script type="module" src="navbar.js"></script>
  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(res => res.text())
      .then(data => document.getElementById("footer-placeholder").innerHTML = data);
  </script>
</body>
</html>
