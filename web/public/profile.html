<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profil | EleÅŸtir-GeliÅŸtir</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://kit.fontawesome.com/3e9484d64b.js" crossorigin="anonymous"></script>
  <style>

    .post-actions {
  display: flex;
  gap: 15px;
  margin-top: 10px;
  padding: 0 10px;
}
.post-actions span {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 15px;
  color: #444;
}
.post-actions i {
  color: #444;
}

    /* KÄ±saltÄ±lmÄ±ÅŸ stiller - seninle aynÄ± */
    .profile-header { display: flex; align-items: center; padding: 20px; background: white; border-radius: 12px; margin: 20px auto; max-width: 700px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .profile-header img.avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-right: 20px; }
    .tab-buttons { display: flex; justify-content: center; margin-top: 20px; }
    .tab-btn { background: #eee; border: none; padding: 10px 20px; margin: 0 5px; cursor: pointer; border-radius: 20px; transition: 0.3s; }
    .tab-btn.active { background-color: #ffa726; color: white; font-weight: bold; }
    .tab-content { display: none; max-width: 700px; margin: 20px auto; }
    .tab-content.active { display: block; }
    .post-card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .post-header { display: flex; align-items: center; }
    .post-header .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .post-actions { display: flex; gap: 15px; margin-top: 10px; }
    .step-section { margin-top: 10px; }
    .step-title { font-weight: bold; margin-top: 10px; }
    .step-body { padding-left: 10px; color: #555; }
    .profile-texts {
  display: flex;
  flex-direction: column;
  justify-content: center;
  color: #222;
}

.profile-texts p {
  margin: 4px 0;
}

.profile-texts .stats {
  display: flex;
  gap: 20px;
  margin-top: 8px;
  font-size: 15px;
}

.profile-texts .stats div {
  text-align: center;
}
.bio-text {
  margin-top: 6px;
  font-size: 15px;
  color: #111;
}

.stats.clickable-stats div {
  cursor: pointer;
  transition: color 0.2s;
  text-align: center;
}

.stats.clickable-stats div:hover {
  color: #ffa726;
}
/* Profil DÃ¼zenle ve Ã‡Ä±kÄ±ÅŸ Yap butonlarÄ± iÃ§in stil */
.profile-header button {
  margin-left: 10px;
  margin-top: 10px;
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.3s ease;
  display: inline-block;
}

/* Profil DÃ¼zenle butonu yeÅŸil olsun */
/* Profil DÃ¼zenle butonu yeÅŸil olsun */
.profile-header button.profile-edit-btn {
  background-color: #4CAF50; /* CanlÄ±, orta ton yeÅŸil */
  color: white;
  transition: background-color 0.3s ease;
}

.profile-header button.profile-edit-btn:hover {
  background-color: #45a040; /* Hover durumunda biraz daha koyu bir yeÅŸil */
}

.profile-header button.profile-logout-btn {
  background-color: #d32f2f;
  color: white;
}

.profile-header button.profile-logout-btn:hover {
  background-color: #c62828;
}

/* Butonlar arasÄ±ndaki mesafeyi ayarlama */
.profile-header {
  display: flex;
  align-items: center;
  padding: 20px;
  background: white;
  border-radius: 12px;
  margin: 20px auto;
  max-width: 700px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.profile-texts {
  display: flex;
  flex-direction: column;
  justify-content: center;
  color: #222;
  margin-right: auto; /* ButonlarÄ± saÄŸa itmek iÃ§in */
}


  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <div class="profile-header">
    <img src="assets/avatars/avatar1.png" class="avatar" alt="Avatar" />
    <div class="profile-texts">
      <h2 id="profile-name">cihan</h2>
      <p id="profile-username">@ilimbeser</p>
    
      <!-- Biyografi -->
      <p class="bio-text" style="font-weight: 600;">
        <span id="profile-bio">Nisan deÄŸilse MayÄ±s</span>
      </p>
    
      <!-- Ä°statistikler -->
      <div class="stats clickable-stats" style="font-weight: bold;">
        <div onclick="alert('TakipÃ§i listesi yakÄ±nda');">
          <strong id="followers-count">143</strong><br>TakipÃ§i
        </div>
        <div onclick="alert('Takip edilenler yakÄ±nda');">
          <strong id="following-count">87</strong><br>Takip
        </div>
        <div>
          <strong id="usefulness-score">8.9/10</strong><br>FaydalÄ±lÄ±k
        </div>
        <div>
          <strong id="posts-count">0</strong><br>Post
        </div>
      </div>
    </div>
    
  </div>
  
    
  </div>

  <div class="tab-buttons">
    <button class="tab-btn active" onclick="showTab(0)">Devam Ediyor</button>
    <button class="tab-btn" onclick="showTab(1)">TamamlandÄ±</button>
    <button class="tab-btn" onclick="showTab(2)">Kaydedilenler</button>
  </div>
  <div class="tab-content active" id="tab-0"></div>
  <div class="tab-content" id="tab-1"></div>
  <div class="tab-content" id="tab-2"></div>

  <!-- Firebase ve JS -->
  <script type="module">
import { showProfileEditWidget } from './profileEdit.js';
import { toggleLike, toggleSave } from './interactions.js';
import { auth, db } from './firebase.js'; // âœ” Sadece buradan al
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { doc, getDoc, collection, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


async function generatePostHTML(post, docId, uid) {
    const isLiked = post.likedBy?.includes(uid);
    const isSaved = post.savedBy?.includes(uid);
    const progress = post.progressStep ?? 0;
    let authorPhoto = 'assets/avatars/avatar1.png';
    let authorName = 'KullanÄ±cÄ±';

    try {
        const userSnap = await getDoc(doc(db, "users", post.authorId));
        if (userSnap.exists()) {
            const userData = userSnap.data();
            authorPhoto = userData.photoUrl || 'assets/avatars/avatar1.png';
            authorName = userData.username || 'KullanÄ±cÄ±';
        }
    } catch (e) {
        console.error("Yazar bilgisi alÄ±namadÄ±", e);
    }

    return `
        <div class="post-card">
            <div onclick="goToPostDetail('${docId}')" style="cursor: pointer;">
                <div class="post-header">
                    <img src="${authorPhoto}" class="avatar" alt="Avatar">
                    <div class="author-info">
                        <p class="author-name">${authorName}</p>
                        <p class="post-date">${new Date(post.date?.seconds * 1000).toLocaleString("tr-TR")}</p>
                    </div>
                </div>
                <div class="post-content"><p>${post.content || ''}</p></div>
                <div class="step-section">
                    <div class="step-title">ðŸ’¡ EleÅŸtir</div>
                    <div class="step-body">${progress >= 1 ? (post.step1Note || 'HenÃ¼z not girilmemiÅŸ.') : 'HenÃ¼z bu aÅŸamaya geÃ§ilmedi.'}</div>
                    <div class="step-title">ðŸ›  DÃ¼ÅŸÃ¼ndÃ¼r</div>
                    <div class="step-body">${progress >= 2 ? (post.step2Note || 'HenÃ¼z not girilmemiÅŸ.') : 'HenÃ¼z bu aÅŸamaya geÃ§ilmedi.'}</div>
                    <div class="step-title">âœ… GeliÅŸtir</div>
                    <div class="step-body">${progress >= 3 ? (post.step3Note || 'HenÃ¼z not girilmemiÅŸ.') : 'HenÃ¼z bu aÅŸamaya geÃ§ilmedi.'}</div>
                </div>
            </div>
            <div class="post-actions">
                <span id="like-${docId}"><i class="fa${isLiked ? 's' : 'r'} fa-thumbs-up"></i> ${post.likesCount || 0}</span>
                <span onclick="goToPostDetail('${docId}')"><i class="far fa-comment"></i> ${post.commentsCount || 0}</span>
                <span id="save-${docId}"><i class="fa${isSaved ? 's' : 'r'} fa-bookmark"></i></span>
                <span id="share-${docId}"><i class="fas fa-share"></i></span>
                <span><i class="far fa-eye"></i> ${post.views || 0}</span>
            </div>
        </div>
    `;
}

onAuthStateChanged(auth, async (user) => {
    const params = new URLSearchParams(window.location.search);
    const profileUid = params.get("uid") || user.uid;
    if (!profileUid) return;

    const userSnap = await getDoc(doc(db, "users", profileUid));
    if (userSnap.exists()) {
        const data = userSnap.data();
        document.querySelector(".profile-header img.avatar").src = data.photoUrl || 'assets/avatars/avatar1.png';
        document.getElementById("profile-name").textContent = data.username || "KullanÄ±cÄ±";
        document.getElementById("profile-username").textContent = `@${data.username || "kullanici"}`;
        document.getElementById("followers-count").textContent = data.followers || 0;
        document.getElementById("following-count").textContent = data.following || 0;
        document.getElementById("usefulness-score").textContent = data.usefulness || "0/10";

        const postQuery = query(collection(db, "posts"), where("authorId", "==", profileUid));
        const postSnapshot = await getDocs(postQuery);
        document.getElementById("posts-count").textContent = postSnapshot.size || 0;

        if (user.uid === profileUid) {
            const editBtn = document.createElement("button");
            editBtn.textContent = "Profili DÃ¼zenle";
            editBtn.onclick = () => showProfileEditWidget({ uid: profileUid, username: data.username });
            editBtn.classList.add("profile-edit-btn");
            document.querySelector(".profile-header").appendChild(editBtn);

            const logoutBtn = document.createElement("button");
            logoutBtn.textContent = "Ã‡Ä±kÄ±ÅŸ Yap";
            logoutBtn.onclick = () => auth.signOut().then(() => window.location.href = "login.html");
            logoutBtn.classList.add("profile-logout-btn");
            document.querySelector(".profile-header").appendChild(logoutBtn);
        }
    }

    const q = query(collection(db, "posts"), where("authorId", "==", profileUid));
    onSnapshot(q, async (snapshot) => {
        const devam = document.getElementById("tab-0");
        const tamam = document.getElementById("tab-1");
        const kayit = document.getElementById("tab-2");

        devam.innerHTML = tamam.innerHTML = kayit.innerHTML = "";

        for (const docSnap of snapshot.docs) {
            const post = docSnap.data();
            const docId = docSnap.id;
            const html = await generatePostHTML(post, docId, profileUid);

            if (post.progressStep < 3) devam.insertAdjacentHTML("beforeend", html);
            else tamam.insertAdjacentHTML("beforeend", html);

            if (post.savedBy?.includes(profileUid)) {
                kayit.insertAdjacentHTML("beforeend", html);
            }

            setTimeout(() => {
                const likeBtn = document.getElementById(`like-${docId}`);
                const saveBtn = document.getElementById(`save-${docId}`);
                const shareBtn = document.getElementById(`share-${docId}`);

                shareBtn?.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const shareUrl = `${window.location.origin}/post.html?id=${docId}`;
                    if (navigator.share) {
                        navigator.share({ title: post.content?.substring(0, 50) || "GÃ¶nderi", text: "Bu gÃ¶nderiye gÃ¶z at!", url: shareUrl }).catch(console.error);
                    } else {
                        navigator.clipboard.writeText(shareUrl);
                        alert("BaÄŸlantÄ± panoya kopyalandÄ± ðŸ“‹");
                    }
                });

                likeBtn?.addEventListener("click", async () => {
                    const isLiked = post.likedBy?.includes(auth.currentUser?.uid);
                    await toggleLike(docId, profileUid, post.likedBy || []);
                });

                saveBtn?.addEventListener("click", async () => {
                    const isSaved = post.savedBy?.includes(auth.currentUser?.uid);
                    await toggleSave(docId, profileUid, post.savedBy || []);
                });
            }, 0);
        }
    });
});

// ðŸ‘‡ Global fonksiyonlar dÄ±ÅŸarÄ±da olmalÄ±
window.showTab = function (index) {
    document.querySelectorAll('.tab-content').forEach((tab, i) => tab.classList.toggle('active', i === index));
    document.querySelectorAll('.tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === index));
};

window.goToPostDetail = function (postId) {
    window.location.href = `post.html?id=${postId}`;
};
</script>


  <!-- Sekme geÃ§iÅŸi -->
  <script type="module" src="navbar.js"></script>
</body>
</html>
