<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profil | Ele≈ütir-Geli≈ütir</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://kit.fontawesome.com/3e9484d64b.js" crossorigin="anonymous"></script>
  <style>

    .post-actions {
  display: flex;
  gap: 15px;
  margin-top: 10px;
  padding: 0 10px;
}
.post-actions span {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 15px;
  color: #444;
}
.post-actions i {
  color: #444;
}

    /* Kƒ±saltƒ±lmƒ±≈ü stiller - seninle aynƒ± */
    .profile-header { display: flex; align-items: center; padding: 20px; background: white; border-radius: 12px; margin: 20px auto; max-width: 700px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .profile-header img.avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-right: 20px; }
    .tab-buttons { display: flex; justify-content: center; margin-top: 20px; }
    .tab-btn { background: #eee; border: none; padding: 10px 20px; margin: 0 5px; cursor: pointer; border-radius: 20px; transition: 0.3s; }
    .tab-btn.active { background-color: #ffa726; color: white; font-weight: bold; }
    .tab-content { display: none; max-width: 700px; margin: 20px auto; }
    .tab-content.active { display: block; }
    .post-card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .post-header { display: flex; align-items: center; }
    .post-header .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .post-actions { display: flex; gap: 15px; margin-top: 10px; }
    .step-section { margin-top: 10px; }
    .step-title { font-weight: bold; margin-top: 10px; }
    .step-body { padding-left: 10px; color: #555; }
    .profile-texts {
  display: flex;
  flex-direction: column;
  justify-content: center;
  color: #222;
}

.profile-texts p {
  margin: 4px 0;
}

.profile-texts .stats {
  display: flex;
  gap: 20px;
  margin-top: 8px;
  font-size: 15px;
}

.profile-texts .stats div {
  text-align: center;
}
.bio-text {
  margin-top: 6px;
  font-size: 15px;
  color: #111;
}

.stats.clickable-stats div {
  cursor: pointer;
  transition: color 0.2s;
  text-align: center;
}

.stats.clickable-stats div:hover {
  color: #ffa726;
}

  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <div class="profile-header">
    <img src="assets/avatars/avatar1.png" class="avatar" alt="Avatar" />
    <div class="profile-texts">
      <h2 id="profile-name">cihan</h2>
      <p id="profile-username">@ilimbeser</p>
    
      <!-- Biyografi -->
      <p class="bio-text" style="font-weight: 600;">
        <span id="profile-bio">Nisan deƒüilse Mayƒ±s</span>
      </p>
    
      <!-- ƒ∞statistikler -->
      <div class="stats clickable-stats" style="font-weight: bold;">
        <div onclick="alert('Takip√ßi listesi yakƒ±nda');">
          <strong id="followers-count">143</strong><br>Takip√ßi
        </div>
        <div onclick="alert('Takip edilenler yakƒ±nda');">
          <strong id="following-count">87</strong><br>Takip
        </div>
        <div>
          <strong id="usefulness-score">8.9/10</strong><br>Faydalƒ±lƒ±k
        </div>
        <div>
          <strong id="posts-count">0</strong><br>Post
        </div>
      </div>
    </div>
    
  </div>
  
    
  </div>

  <div class="tab-buttons">
    <button class="tab-btn active" onclick="showTab(0)">Devam Ediyor</button>
    <button class="tab-btn" onclick="showTab(1)">Tamamlandƒ±</button>
    <button class="tab-btn" onclick="showTab(2)">Kaydedilenler</button>
  </div>
  <div class="tab-content active" id="tab-0"></div>
  <div class="tab-content" id="tab-1"></div>
  <div class="tab-content" id="tab-2"></div>

  <!-- Firebase ve JS -->
  <script type="module">
    import { toggleLike, toggleSave } from './interactions.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
  getFirestore, doc, getDoc,
  collection, query, where, onSnapshot, getDocs
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



    const firebaseConfig = {
      apiKey: "AIzaSyByrxwGrUPfIFUjsG2Nsv6niu5aM_5v4wM",
      authDomain: "elestir-gelistir.firebaseapp.com",
      projectId: "elestir-gelistir",
      storageBucket: "elestir-gelistir.appspot.com",
      messagingSenderId: "329858460105",
      appId: "1:329858460105:web:0a1940df3d7b57593b6018"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    function generatePostHTML(post, docId, uid) {
  const isLiked = post.likedBy?.includes(uid);
  const isSaved = post.savedBy?.includes(uid);
  const progress = post.progressStep ?? 0;

  // üîΩ URL'den uid parametresini al
const params = new URLSearchParams(window.location.search);
const profileUid = params.get("uid");
if (!profileUid) {
  alert("Profil bulunamadƒ±.");
  throw new Error("UID eksik");
}


  return `
    <div class="post-card">
      <div onclick="goToPostDetail('${docId}')" style="cursor: pointer;">
        <div class="post-header">
          <img src="${post.authorPhotoUrl || 'assets/avatars/avatar1.png'}" class="avatar" alt="Avatar">
          <div class="author-info">
            <p class="author-name">${post.authorName || 'Kullanƒ±cƒ±'}</p>
            <p class="post-date">${new Date(post.date?.seconds * 1000).toLocaleString("tr-TR")}</p>
          </div>
        </div>
        <div class="post-content"><p>${post.content || ''}</p></div>
        <div class="step-section">
          <div class="step-title">üí° Ele≈ütir</div>
          <div class="step-body">${progress >= 1 ? (post.step1Note || 'Hen√ºz not girilmemi≈ü.') : 'Hen√ºz bu a≈üamaya ge√ßilmedi.'}</div>
          <div class="step-title">üõ† D√º≈ü√ºnd√ºr</div>
          <div class="step-body">${progress >= 2 ? (post.step2Note || 'Hen√ºz not girilmemi≈ü.') : 'Hen√ºz bu a≈üamaya ge√ßilmedi.'}</div>
          <div class="step-title">‚úÖ Geli≈ütir</div>
          <div class="step-body">${progress >= 3 ? (post.step3Note || 'Hen√ºz not girilmemi≈ü.') : 'Hen√ºz bu a≈üamaya ge√ßilmedi.'}</div>
        </div>
      </div>

      <!-- Etkile≈üim butonlarƒ± - ≈ûƒ±k ve √ßizgisiz -->
      <div class="post-actions">
        <span id="like-${docId}">
          <i class="fa${isLiked ? 's' : 'r'} fa-thumbs-up"></i> ${post.likesCount || 0}
        </span>
        <span onclick="goToPostDetail('${docId}')">
  <i class="far fa-comment"></i> ${post.commentsCount || 0}
</span>
        <span id="save-${docId}">
          <i class="fa${isSaved ? 's' : 'r'} fa-bookmark"></i>
        </span>
        <span id="share-${docId}">
          <i class="fas fa-share"></i>
        </span>
        <span>
          <i class="far fa-eye"></i> ${post.views || 0}
        </span>
      </div>
    </div>
  `;
}



onAuthStateChanged(auth, async (user) => {
  const params = new URLSearchParams(window.location.search);
  const profileUid = params.get("uid") || user.uid;
  if (!profileUid) return;

  const userSnap = await getDoc(doc(db, "users", profileUid));
if (userSnap.exists()) {
  const data = userSnap.data();
  document.querySelector(".profile-header img.avatar").src =
    `assets/avatars/${data.photoUrl?.split("avatars/")[1] || "avatar1.png"}`;
  document.getElementById("profile-name").textContent = data.username || "Kullanƒ±cƒ±";
  document.getElementById("profile-username").textContent = `@${data.username || "kullanici"}`;
  document.getElementById("followers-count").textContent = data.followers || 0;
  document.getElementById("following-count").textContent = data.following || 0;
  document.getElementById("usefulness-score").textContent = data.usefulness || "0/10";

  // ‚úÖ Post sayƒ±sƒ±nƒ± hesapla ve g√∂ster
  const postQuery = query(collection(db, "posts"), where("authorId", "==", profileUid));
  const postSnapshot = await getDocs(postQuery);
  document.getElementById("posts-count").textContent = postSnapshot.size || 0;
  const isOwnProfile = user && user.uid === profileUid;

  // üëá Kaydedilenler sekmesini gizle (eƒüer kendi profili deƒüilse)
  if (isOwnProfile) {
  const editBtn = document.createElement("button");
  editBtn.textContent = "Profili D√ºzenle";
  editBtn.onclick = () => alert("D√ºzenleme ekranƒ± yakƒ±nda");
  
  // ≈ûƒ±k g√∂r√ºnmesi i√ßin stil
  editBtn.style.marginLeft = "auto";
  editBtn.style.marginTop = "10px";
  editBtn.style.padding = "8px 16px";
  editBtn.style.borderRadius = "20px";
  editBtn.style.border = "none";
  editBtn.style.backgroundColor = "#ffa726";
  editBtn.style.color = "white";
  editBtn.style.fontWeight = "bold";
  editBtn.style.cursor = "pointer";

  document.querySelector(".profile-header").appendChild(editBtn);
}
if (isOwnProfile) {
  const logoutBtn = document.createElement("button");
  logoutBtn.textContent = "√áƒ±kƒ±≈ü Yap";
  logoutBtn.onclick = () => auth.signOut().then(() => window.location.href = "login.html");

  // Stil
  logoutBtn.style.marginLeft = "10px";
  logoutBtn.style.marginTop = "10px";
  logoutBtn.style.padding = "8px 16px";
  logoutBtn.style.borderRadius = "20px";
  logoutBtn.style.border = "none";
  logoutBtn.style.backgroundColor = "#d32f2f";
  logoutBtn.style.color = "white";
  logoutBtn.style.fontWeight = "bold";
  logoutBtn.style.cursor = "pointer";

  document.querySelector(".profile-header").appendChild(logoutBtn);
}


}

      
      // Firebase'den gelen veriler


      const q = query(collection(db, "posts"), where("authorId", "==", profileUid));
      onSnapshot(q, (snapshot) => {
        const devam = document.getElementById("tab-0");
        const tamam = document.getElementById("tab-1");
        const kayit = document.getElementById("tab-2");
        devam.innerHTML = tamam.innerHTML = kayit.innerHTML = "";

        

        snapshot.forEach(docSnap => {
          const post = docSnap.data();
          const docId = docSnap.id;
          const html = generatePostHTML(post, docId, profileUid);

          if (post.progressStep < 3) devam.insertAdjacentHTML("beforeend", html);
          else tamam.insertAdjacentHTML("beforeend", html);

          if (post.savedBy?.includes(profileUid)) {
            kayit.insertAdjacentHTML("beforeend", html);
          }

          // Butonlara event ekle
          setTimeout(() => {
            const likeBtn = document.getElementById(`like-${docId}`);
            const saveBtn = document.getElementById(`save-${docId}`);
            const shareBtn = document.getElementById(`share-${docId}`);
if (shareBtn) {
  shareBtn.addEventListener("click", (e) => {
    e.stopPropagation(); // Kart detayƒ±na tƒ±klanmasƒ±nƒ± engelle

    const shareUrl = `${window.location.origin}/post.html?id=${docId}`;
    if (navigator.share) {
      navigator.share({
        title: post.content?.substring(0, 50) || "G√∂nderi",
        text: "Bu g√∂nderiye g√∂z at!",
        url: shareUrl,
      }).catch((err) => console.error("Payla≈üƒ±m iptal edildi", err));
    } else {
      navigator.clipboard.writeText(shareUrl);
      alert("Baƒülantƒ± panoya kopyalandƒ± üìã");
    }
  });
}


            if (likeBtn) {
              likeBtn.addEventListener("click", async () => {
                const isLiked = post.likedBy?.includes(auth.currentUser?.uid);
                await toggleLike(docId, profileUid, post.likedBy || []);
                const icon = likeBtn.querySelector("i");
                let count = parseInt(likeBtn.textContent.trim().split(" ").pop());
                icon.classList.replace(isLiked ? "fas" : "far", isLiked ? "far" : "fas");
                likeBtn.innerHTML = `<i class="fa${isLiked ? "r" : "s"} fa-thumbs-up"></i> ${isLiked ? count - 1 : count + 1}`;
              });
            }

            if (saveBtn) {
              saveBtn.addEventListener("click", async () => {
                const isSaved = post.savedBy?.includes(auth.currentUser?.uid);
                await toggleSave(docId, profileUid, post.savedBy || []);
                const icon = saveBtn.querySelector("i");
                icon.classList.replace(isSaved ? "fas" : "far", isSaved ? "far" : "fas");
              });
            }
          }, 0);
        });
      });
    });












    window.showTab = function(index) {
  const tabs = document.querySelectorAll('.tab-content');
  const buttons = document.querySelectorAll('.tab-btn');

  tabs.forEach((tab, i) => {
    tab.classList.toggle('active', i === index);
  });

  buttons.forEach((btn, i) => {
    btn.classList.toggle('active', i === index);
  });
};
window.goToPostDetail = function (postId) {
  window.location.href = `post.html?id=${postId}`;
};


  </script>

  <!-- Sekme ge√ßi≈üi -->
  <script type="module" src="navbar.js"></script>
</body>
</html>
