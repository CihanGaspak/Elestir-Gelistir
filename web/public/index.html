<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eleştir-Geliştir | Ana Sayfa</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://kit.fontawesome.com/3e9484d64b.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    .category-bar {
      display: flex;
      overflow-x: auto;
      padding: 10px;
      background: white;
      max-width: 700px;
      margin: 20px auto 10px;
      border-radius: 12px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      gap: 10px;
    }

    .category-btn {
      padding: 8px 16px;
      background: #eee;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      transition: 0.3s;
    }

    .category-btn.active {
      background-color: #ffa726;
      color: white;
      font-weight: bold;
    }

    .write-post-container {
      background: white;
      padding: 15px;
      margin: 20px auto;
      max-width: 700px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .user-profile {
      display: flex;
      align-items: center;
    }

    .user-profile img.avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .post-input-container {
      margin-top: 10px;
    }

    .post-input-container textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .category-select {
      margin-top: 10px;
      padding: 8px;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .btn {
      margin-top: 10px;
      background-color: #ffa726;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn:disabled {
  background-color: gray;
  cursor: not-allowed;
}
.post-card {
  background: white;
  padding: 15px;
  margin: 15px auto;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
  max-width: 700px;
}

.post-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.post-header .avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 10px;
}

.step-section {
  margin-top: 10px;
}

.step-title {
  font-weight: bold;
  margin-top: 8px;
}

.step-body {
  padding-left: 10px;
  color: #555;
}

.post-actions {
  display: flex;
  gap: 15px;
  margin-top: 10px;
  padding: 0 10px;
}

.post-actions span {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 15px;
  color: #444;
}

.daily-highlight {
  background: linear-gradient(135deg, #ffe6cc, #fff8f0);
  padding: 16px;
  border-radius: 12px;
  margin: 20px auto;
  max-width: 700px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.highlight-header {
  font-size: 18px;
  font-weight: bold;
  color: #ff7700;
  margin-bottom: 10px;
}

.highlight-card {
  display: flex;
  gap: 12px;
  cursor: pointer;
  background: white;
  border-radius: 10px;
  padding: 12px;
  transition: 0.2s ease;
}

.highlight-card:hover {
  transform: scale(1.02);
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.highlight-avatar img {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
}

.highlight-content h3 {
  margin: 0;
  color: #333;
}

.highlight-content p {
  margin: 4px 0;
  color: #555;
  font-style: italic;
}

.highlight-meta {
  font-size: 12px;
  color: #999;
  margin-top: 6px;
  display: flex;
  justify-content: space-between;
}
.main-container {
  display: flex;
  gap: 20px;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  flex-wrap: wrap;
}

.left-column,
.right-column {
  flex: 0 0 260px;
}

.center-column {
  flex: 1 1 700px;
  max-width: 700px;
  min-width: 300px;
}

  </style>
</head>
<body>

  
  <div id="navbar-placeholder"></div>

  <div class="main-container">
    <div class="left-column">
      <div id="left-sidebar-placeholder"></div>
    </div>
  
    <div class="center-column">
    <div style="text-align: center; margin-top: 10px;">
 
    <div class="ai-card">
  <div class="ai-card-left">
    <div class="ai-card-title">🤖 AI Chatbot</div>
    <div class="ai-card-desc">
      Merak ettiğin her şeyi sorabilirsin! <br>
      Yapay zekâdan <strong>öneri</strong>, <strong>fikir</strong>, <strong>rehberlik</strong> al!
    </div>
    <button onclick="window.open('chatbot.html', '_blank')" class="ai-open-btn">Chatbot'u Aç</button>
  </div>
  <div class="ai-card-right">
    <p class="sample-question-title">🧠 Popüler Sorular</p>
    <ul>
      <li>✔️ Evde internetle nasıl para kazanılır?</li>
      <li>✔️ Hangi mesleği seçmeliyim?</li>
      <li>✔️ Zamanımı daha verimli nasıl kullanırım?</li>
    </ul>
  </div>
</div>

</div>


  
      <!-- Kategori Barı -->
    <div class="category-bar" id="categoryBar">
      <button class="category-btn active" onclick="filterPosts('Tümü')">Tümü</button>
      <button class="category-btn" onclick="filterPosts('Eğitim')">Eğitim</button>
      <button class="category-btn" onclick="filterPosts('Spor')">Spor</button>
      <button class="category-btn" onclick="filterPosts('Tamirat')">Tamirat</button>
      <button class="category-btn" onclick="filterPosts('Araç Bakım')">Araç Bakım</button>
      <button class="category-btn" onclick="filterPosts('Sağlık')">Sağlık</button>
      <button class="category-btn" onclick="filterPosts('Teknoloji')">Teknoloji</button>
      <button class="category-btn" onclick="filterPosts('Kişisel Gelişim')">Kişisel Gelişim</button>
      <button class="category-btn" onclick="filterPosts('Sanat')">Sanat</button>
      <button class="category-btn" onclick="filterPosts('Yazılım')">Yazılım</button>
    </div>
  
    <!-- Yazı Paylaşma Alanı -->
    <div class="write-post-container">
      <div class="user-profile" style="margin-bottom: 10px;">
        <img id="user-avatar" src="assets/avatars/avatar1.png" class="avatar" alt="Avatar" />
        <div><p id="post-username">Kullanıcı</p></div>
      </div>
  
      <div class="post-input-container">
        <textarea id="post-content" rows="3" maxlength="280" placeholder="Kafandaki soru işaretleri nedir?" oninput="updateCharCount()"></textarea>
        <div style="text-align: right; font-size: 12px; color: gray;">
          <span id="char-count">0</span>/280
        </div>
        <select id="selected-category" class="category-select">
          <option value="" disabled selected>Kategori seç</option>
          <option value="Eğitim">Eğitim</option>
          <option value="Spor">Spor</option>
          <option value="Tamirat">Tamirat</option>
          <option value="Araç Bakım">Araç Bakım</option>
          <option value="Sağlık">Sağlık</option>
          <option value="Teknoloji">Teknoloji</option>
          <option value="Kişisel Gelişim">Kişisel Gelişim</option>
          <option value="Sanat">Sanat</option>
          <option value="Yazılım">Yazılım</option>
        </select>
        <button id="submit-button" class="btn" onclick="submitPost()" disabled>Gönder</button>
      </div>
    </div>
  
    <!-- Günün Geliştirisi Alanı -->
  <div id="daily-highlight"></div>
  
    <!-- Gönderi Listeleme Alanı -->
  <div id="post-feed" style="max-width: 700px; margin: auto; margin-top: 20px;"></div>
    </div>
  
    
  <!-- Sağ Sütun -->
  <div class="right-column">
    <div id="right-sidebar-placeholder"></div>
  </div>
  </div>


  <!-- Dinamik Navbar -->
  <script type="module" src="navbar.js"></script>

  <!-- Kullanıcı ve Gönderi Verisi -->
  <script type="module">
    import { toggleLike, toggleSave } from './interactions.js';
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
  getFirestore,
  doc,
  getDoc,
  addDoc,
  collection,
  query,
  onSnapshot,
  getDocs
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  
    const firebaseConfig = {
      apiKey: "AIzaSyByrxwGrUPfIFUjsG2Nsv6niu5aM_5v4wM",
      authDomain: "elestir-gelistir.firebaseapp.com",
      projectId: "elestir-gelistir",
      storageBucket: "elestir-gelistir.appspot.com",
      messagingSenderId: "329858460105",
      appId: "1:329858460105:web:0a1940df3d7b57593b6018"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
  
    let currentUser = null;
    let allPosts = [];
  
    const postFeed = document.getElementById("post-feed");
  
    onAuthStateChanged(auth, async (user) => {
  if (user) {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      currentUser = {
        uid: user.uid,
        ...userDoc.data()
      };
      document.getElementById("post-username").textContent = currentUser.username;
      if (currentUser.photoUrl?.startsWith("assets/")) {
        document.getElementById("user-avatar").src = currentUser.photoUrl;
      }
    }
     renderPosts("Tümü");
  }
});


onSnapshot(collection(db, "posts"), snapshot => {
  allPosts = snapshot.docs.map(doc => ({
    docId: doc.id,
    data: doc.data()
  }));
});

  
    window.submitPost = async function () {
      const content = document.getElementById("post-content").value.trim();
      const category = document.getElementById("selected-category").value;
      if (!content || !category || !currentUser) {
        alert("Tüm alanları doldurun veya giriş yapın.");
        return;
      }
  
      await addDoc(collection(db, "posts"), {
        content: content,
        category: category,
        authorId: currentUser.uid,
        authorName: currentUser.username,
        authorPhotoUrl: currentUser.photoUrl || '',
        date: new Date(),
        dailyPick: false,
        progressStep: 0,
        likedBy: [],
        savedBy: [],
        views: 0,
        likesCount: 0,
        commentsCount: 0
      });
  
      alert("Gönderi başarıyla paylaşıldı!");
      document.getElementById("post-content").value = "";
      document.getElementById("selected-category").value = "";
      document.getElementById("char-count").textContent = "0";
      document.getElementById("submit-button").disabled = true;
      document.getElementById("submit-button").style.backgroundColor = "gray";
    };
  
async function renderPosts(category = "Tümü") {
  postFeed.innerHTML = "";
  const uid = currentUser?.uid || "";
  const filtered = category === "Tümü"
    ? allPosts
    : allPosts.filter(post => post.data.category === category);

  for (const { docId, data } of filtered) {
    const postHTML = await generatePostHTML(data, docId, uid);
    postFeed.insertAdjacentHTML("beforeend", postHTML);
    attachPostEvents(docId, data, uid, category); // 🟢 Her post için ayrı event ekle
  }
}

// 🔥 Tek tek buton event'leri ekleyen fonksiyon
function attachPostEvents(docId, data, uid, category) {
  // Her zaman güncel DOM'dan al
  const likeBtn = document.getElementById(`like-${docId}`);
  const saveBtn = document.getElementById(`save-${docId}`);
  const shareBtn = document.getElementById(`share-${docId}`);

  if (likeBtn) {
    likeBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      await toggleLike(docId, uid, data.likedBy || []);
      // ✅ Güncel datayı çekip sadece o postu güncelle
      const updatedDoc = await getDoc(doc(db, "posts", docId));
      const updatedData = updatedDoc.data();
      const postContainer = document.getElementById(`post-card-${docId}`);
      postContainer.outerHTML = await generatePostHTML(updatedData, docId, uid);
      // ✅ Yeni DOM elemanına tekrar event ekle (kendini tekrar bağlar)
      attachPostEvents(docId, updatedData, uid, category);
    });
  }

  if (saveBtn) {
    saveBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      await toggleSave(docId, uid, data.savedBy || []);
      const updatedDoc = await getDoc(doc(db, "posts", docId));
      const updatedData = updatedDoc.data();
      const postContainer = document.getElementById(`post-card-${docId}`);
      postContainer.outerHTML = await generatePostHTML(updatedData, docId, uid);
      attachPostEvents(docId, updatedData, uid, category);
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const url = `${window.location.origin}/post.html?id=${docId}`;
      navigator.clipboard.writeText(url);
      alert("Bağlantı panoya kopyalandı 📋");
    });
  }
}

  
    // ⛳️ filterPosts fonksiyonunu global hale getiriyoruz:
    window.filterPosts = function (category) {
      document.querySelectorAll(".category-btn").forEach(btn => btn.classList.remove("active"));
      const activeBtn = Array.from(document.querySelectorAll(".category-btn")).find(btn =>
        btn.textContent.trim() === category);
      if (activeBtn) activeBtn.classList.add("active");
  
      renderPosts(category);
    };

    // 🔥 timeAgo fonksiyonu global olarak bir kez tanımlanır
function timeAgo(date) {
  const now = new Date();
  const seconds = Math.floor((now - date) / 1000);

  let interval = Math.floor(seconds / 31536000);
  if (interval >= 1) return `${interval} yıl önce`;

  interval = Math.floor(seconds / 2592000);
  if (interval >= 1) return `${interval} ay önce`;

  interval = Math.floor(seconds / 86400);
  if (interval >= 1) return `${interval} gün önce`;

  interval = Math.floor(seconds / 3600);
  if (interval >= 1) return `${interval} saat önce`;

  interval = Math.floor(seconds / 60);
  if (interval >= 1) return `${interval} dakika önce`;

  return "Az önce";
}

// 🔥 generatePostHTML fonksiyonu sadece işine odaklanır
async function generatePostHTML(post, docId, uid) {
  // Kullanıcı verisini Firestore'dan al
  let authorData = { username: "Kullanıcı", photoUrl: "assets/avatars/avatar1.png" };
  try {
    const userSnap = await getDoc(doc(db, "users", post.authorId));
    if (userSnap.exists()) {
      authorData = userSnap.data();
    }
  } catch (e) {
    console.error("Kullanıcı verisi alınamadı:", e);
  }

  const isLiked = post.likedBy?.includes(uid);
const likeIconClass = isLiked ? 'fas' : 'far';
const likeColor = isLiked ? 'orange' : 'black';


  const isSaved = post.savedBy?.includes(uid);
  const saveColor = isSaved ? 'orange' : 'black';
  const saveIconClass = isSaved ? 'fas' : 'far';

  const progress = post.progressStep ?? 0;
  const postDateObj = new Date(post.date?.seconds * 1000);
  const postDate = timeAgo(postDateObj);

  const progressIcons = [
    { icon: "fas fa-lightbulb", label: "Fikir" },
    { icon: "fas fa-tools", label: "Çözüm" },
    { icon: "fas fa-check-circle", label: "Sonuç" }
  ];

  const categoryIcons = {
    "Eğitim": "fas fa-school",
    "Spor": "fas fa-basketball-ball",
    "Teknoloji": "fas fa-microchip",
    "Tamirat": "fas fa-tools",
    "Sağlık": "fas fa-heartbeat",
    "Sanat": "fas fa-palette",
    "Yazılım": "fas fa-code",
    "Kişisel Gelişim": "fas fa-user-graduate",
    "Araç Bakım": "fas fa-car",
    "Diğer": "fas fa-ellipsis-h"
  };

  const progressHtml = progressIcons.map((step, index) => `
    <i class="${step.icon}" title="${step.label}"
      style="color:${index === 0 ? 'orange' : (progress >= index + 1 ? 'orange' : '#ccc')}; margin-right:6px;"></i>
  `).join('');

  const categoryHtml = `
    <i class="${categoryIcons[post.category] || categoryIcons['Diğer']}" style="color:#666; margin-right:4px;"></i> ${post.category || 'Diğer'}
  `;

  return `
    <div class="post-card" id="post-card-${docId}">
      <div onclick="goToPostDetail('${docId}')" style="cursor: pointer;">
        <div class="post-header">
          <img src="${authorData.photoUrl}" class="avatar" alt="Avatar">
          <div class="author-info">
            <p class="author-name">${authorData.username}</p>
             <p class="post-date">${timeAgo(new Date(post.date?.seconds * 1000))}</p>
          </div>
          <div style="margin-left:auto; text-align:right;">
            <div>${progressHtml}</div>
            <div style="font-size:12px; color:#555; margin-top:4px;">${categoryHtml}</div>
          </div>
        </div>
        <div class="post-content"><p>${post.content || ''}</p></div>
        <div class="step-section">
          <div class="step-title">💡 Eleştir</div>
          <div class="step-body">${progress >= 1 ? (post.step1Note || 'Henüz not girilmemiş.') : 'Henüz bu aşamaya geçilmedi.'}</div>
          <div class="step-title">🛠 Düşündür</div>
          <div class="step-body">${progress >= 2 ? (post.step2Note || 'Henüz not girilmemiş.') : 'Henüz bu aşamaya geçilmedi.'}</div>
          <div class="step-title">✅ Geliştir</div>
          <div class="step-body">${progress >= 3 ? (post.step3Note || 'Henüz not girilmemiş.') : 'Henüz bu aşamaya geçilmedi.'}</div>
        </div>
      </div>

      <div class="post-actions">
        <span id="like-${docId}">
          <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up" style="color:${isLiked ? 'orange' : 'black'};"></i> ${post.likesCount || 0}
        </span>
        <span><i class="far fa-comment"></i> ${post.commentsCount || 0}</span>
        <span id="save-${docId}">
          <i class="${isSaved ? 'fas' : 'far'} fa-bookmark" style="color:${isSaved ? 'orange' : 'black'};"></i>
        </span>
        <span id="share-${docId}"><i class="fas fa-share"></i></span>
        <span><i class="far fa-eye"></i> ${post.views || 0}</span>
      </div>
    </div>
  `;
}


  
    onSnapshot(collection(db, "posts"), snapshot => {
      allPosts = snapshot.docs.map(doc => ({
        docId: doc.id,
        data: doc.data()
      }));
      // GÜNÜN GELİŞTİRİSİ BURADA ÇEKİLSİN
      loadDailyPost();
    });

    window.goToPostDetail = function (docId) {
  window.location.href = `post.html?id=${docId}`;
};

async function loadDailyPost() {
  const postRef = collection(db, "posts");
  const querySnapshot = await getDocs(postRef);

  const dailyPosts = [];
  querySnapshot.forEach(doc => {
    const data = doc.data();
    if (data.dailyPick === true) {
      dailyPosts.push({ id: doc.id, ...data });
    }
  });

  if (dailyPosts.length === 0) {
    document.getElementById("daily-highlight").innerHTML = `<div class="daily-highlight">Bugün için seçilen bir gönderi yok.</div>`;
    return;
  }

  const randomIndex = Math.floor(Math.random() * dailyPosts.length);
  const post = dailyPosts[randomIndex];

  // 🔥 Burada authorId'den kullanıcı verisini çekiyoruz:
  let authorData = { username: "Kullanıcı", photoUrl: "assets/avatars/avatar1.png" };
  try {
    const userSnap = await getDoc(doc(db, "users", post.authorId));
    if (userSnap.exists()) {
      authorData = userSnap.data();
    }
  } catch (e) {
    console.error("Kullanıcı verisi alınamadı:", e);
  }

  const dailyHTML = `
  <div class="daily-highlight">
    <div class="highlight-header">
      <span>✨ Günün Eleştirisi</span>
    </div>
    <div class="highlight-card" onclick="goToPostDetail('${post.id}')">
      <div class="highlight-avatar">
        <img src="${authorData.photoUrl}" alt="Kullanıcı Avatarı">
      </div>
      <div class="highlight-content">
        <h3>Kategori: <span>${post.category || 'Genel'}</span></h3>
        <p>"${post.content?.substring(0, 120) || ''}..."</p>
        <div class="highlight-meta">
          <span>👤 ${authorData.username}</span>
          <span>🗓️ ${post.date?.seconds ? new Date(post.date.seconds * 1000).toLocaleDateString("tr-TR") : ''}</span>
        </div>
      </div>
    </div>
  </div>`;

  document.getElementById("daily-highlight").innerHTML = dailyHTML;
}


  </script>
  

  <script>
    function updateCharCount() {
      const textarea = document.getElementById("post-content");
      const charCount = textarea.value.length;
      document.getElementById("char-count").textContent = charCount;
  
      const button = document.getElementById("submit-button");
      if (charCount > 0 && charCount <= 280) {
        button.disabled = false;
        button.style.backgroundColor = "#ffa726";
        button.style.cursor = "pointer";
      } else {
        button.disabled = true;
        button.style.backgroundColor = "gray";
        button.style.cursor = "not-allowed";
      }
    }
  </script>
  
  <script type="module">
    // Sol sütun
    fetch('sol_sutun.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('left-sidebar-placeholder').innerHTML = html;
        return import('./leftSidebar.js');
      })
      .catch(console.error);
  
    // Sağ sütun
    fetch('sag_sutun.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('right-sidebar-placeholder').innerHTML = html;
        return import('./rightSidebar.js');
      })
      .catch(console.error);
  </script>
  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(res => res.text())
      .then(data => document.getElementById("footer-placeholder").innerHTML = data);
  </script>
  
</body>
</html>
