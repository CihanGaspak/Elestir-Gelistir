<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eleştir-Geliştir | Ana Sayfa</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://kit.fontawesome.com/3e9484d64b.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    .category-bar {
      display: flex;
      overflow-x: auto;
      padding: 10px;
      background: white;
      max-width: 700px;
      margin: 20px auto 10px;
      border-radius: 12px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      gap: 10px;
    }

    .category-btn {
      padding: 8px 16px;
      background: #eee;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      transition: 0.3s;
    }

    .category-btn.active {
      background-color: #ffa726;
      color: white;
      font-weight: bold;
    }

    .write-post-container {
      background: white;
      padding: 15px;
      margin: 20px auto;
      max-width: 700px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .user-profile {
      display: flex;
      align-items: center;
    }

    .user-profile img.avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .post-input-container {
      margin-top: 10px;
    }

    .post-input-container textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .category-select {
      margin-top: 10px;
      padding: 8px;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .btn {
      margin-top: 10px;
      background-color: #ffa726;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn:disabled {
  background-color: gray;
  cursor: not-allowed;
}
.post-card {
  background: white;
  padding: 15px;
  margin: 15px auto;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
  max-width: 700px;
}

.post-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.post-header .avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 10px;
}

.step-section {
  margin-top: 10px;
}

.step-title {
  font-weight: bold;
  margin-top: 8px;
}

.step-body {
  padding-left: 10px;
  color: #555;
}

.post-actions {
  display: flex;
  gap: 15px;
  margin-top: 10px;
  padding: 0 10px;
}

.post-actions span {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 15px;
  color: #444;
}


  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <!-- Kategori Barı -->
  <div class="category-bar" id="categoryBar">
    <button class="category-btn active" onclick="filterPosts('Tümü')">Tümü</button>
    <button class="category-btn" onclick="filterPosts('Eğitim')">Eğitim</button>
    <button class="category-btn" onclick="filterPosts('Spor')">Spor</button>
    <button class="category-btn" onclick="filterPosts('Tamirat')">Tamirat</button>
    <button class="category-btn" onclick="filterPosts('Araç Bakım')">Araç Bakım</button>
    <button class="category-btn" onclick="filterPosts('Sağlık')">Sağlık</button>
    <button class="category-btn" onclick="filterPosts('Teknoloji')">Teknoloji</button>
    <button class="category-btn" onclick="filterPosts('Kişisel Gelişim')">Kişisel Gelişim</button>
    <button class="category-btn" onclick="filterPosts('Sanat')">Sanat</button>
    <button class="category-btn" onclick="filterPosts('Yazılım')">Yazılım</button>
  </div>

  <!-- Yazı Paylaşma Alanı -->
  <div class="write-post-container">
    <div class="user-profile" style="margin-bottom: 10px;">
      <img id="user-avatar" src="assets/avatars/avatar1.png" class="avatar" alt="Avatar" />
      <div><p id="post-username">Kullanıcı</p></div>
    </div>

    <div class="post-input-container">
      <textarea id="post-content" rows="3" maxlength="280" placeholder="Kafandaki soru işaretleri nedir?" oninput="updateCharCount()"></textarea>
      <div style="text-align: right; font-size: 12px; color: gray;">
        <span id="char-count">0</span>/280
      </div>
      <select id="selected-category" class="category-select">
        <option value="" disabled selected>Kategori seç</option>
        <option value="Eğitim">Eğitim</option>
        <option value="Spor">Spor</option>
        <option value="Tamirat">Tamirat</option>
        <option value="Araç Bakım">Araç Bakım</option>
        <option value="Sağlık">Sağlık</option>
        <option value="Teknoloji">Teknoloji</option>
        <option value="Kişisel Gelişim">Kişisel Gelişim</option>
        <option value="Sanat">Sanat</option>
        <option value="Yazılım">Yazılım</option>
      </select>
      <button id="submit-button" class="btn" onclick="submitPost()" disabled>Gönder</button>
    </div>
  </div>

  <!-- Gönderi Listeleme Alanı -->
<div id="post-feed" style="max-width: 700px; margin: auto; margin-top: 20px;"></div>


  <!-- Dinamik Navbar -->
  <script type="module" src="navbar.js"></script>

  <!-- Kullanıcı ve Gönderi Verisi -->
  <script type="module">
    import { toggleLike, toggleSave } from './interactions.js';
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      addDoc,
      collection,
      query,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyByrxwGrUPfIFUjsG2Nsv6niu5aM_5v4wM",
      authDomain: "elestir-gelistir.firebaseapp.com",
      projectId: "elestir-gelistir",
      storageBucket: "elestir-gelistir.appspot.com",
      messagingSenderId: "329858460105",
      appId: "1:329858460105:web:0a1940df3d7b57593b6018"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
  
    let currentUser = null;
    let allPosts = [];
  
    const postFeed = document.getElementById("post-feed");
  
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          currentUser = {
            uid: user.uid,
            ...userDoc.data()
          };
          document.getElementById("post-username").textContent = currentUser.username;
          if (currentUser.photoUrl?.startsWith("assets/")) {
            document.getElementById("user-avatar").src = currentUser.photoUrl;
          }
        }
      }
    });
  
    window.submitPost = async function () {
      const content = document.getElementById("post-content").value.trim();
      const category = document.getElementById("selected-category").value;
      if (!content || !category || !currentUser) {
        alert("Tüm alanları doldurun veya giriş yapın.");
        return;
      }
  
      await addDoc(collection(db, "posts"), {
        content: content,
        category: category,
        authorId: currentUser.uid,
        authorName: currentUser.username,
        authorPhotoUrl: currentUser.photoUrl || '',
        date: new Date(),
        progressStep: 1,
        likedBy: [],
        savedBy: [],
        views: 0,
        likesCount: 0,
        commentsCount: 0
      });
  
      alert("Gönderi başarıyla paylaşıldı!");
      document.getElementById("post-content").value = "";
      document.getElementById("selected-category").value = "";
      document.getElementById("char-count").textContent = "0";
      document.getElementById("submit-button").disabled = true;
      document.getElementById("submit-button").style.backgroundColor = "gray";
    };
  
    function renderPosts(category = "Tümü") {
  postFeed.innerHTML = "";
  const uid = currentUser?.uid || "";
  const filtered = category === "Tümü"
    ? allPosts
    : allPosts.filter(post => post.data.category === category);

  filtered.forEach(({ docId, data }) => {
    const postHTML = generatePostHTML(data, docId, uid);
    postFeed.insertAdjacentHTML("beforeend", postHTML);
  });

  // 👍 Etkileşim butonlarını burada aktif ediyoruz:
  setTimeout(() => {
    filtered.forEach(({ docId, data }) => {
      const likeBtn = document.getElementById(`like-${docId}`);
      const saveBtn = document.getElementById(`save-${docId}`);
      const shareBtn = document.getElementById(`share-${docId}`);

      if (likeBtn) {
        likeBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const isLiked = data.likedBy?.includes(currentUser?.uid);
          await toggleLike(docId, currentUser.uid, data.likedBy || []);
          let count = parseInt(likeBtn.textContent.trim().split(" ").pop());
          const icon = likeBtn.querySelector("i");
          icon.classList.replace(isLiked ? "fas" : "far", isLiked ? "far" : "fas");
          likeBtn.innerHTML = `<i class="fa${isLiked ? "r" : "s"} fa-thumbs-up"></i> ${isLiked ? count - 1 : count + 1}`;
        });
      }

      if (saveBtn) {
        saveBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const isSaved = data.savedBy?.includes(currentUser?.uid);
          await toggleSave(docId, currentUser.uid, data.savedBy || []);
          const icon = saveBtn.querySelector("i");
          icon.classList.replace(isSaved ? "fas" : "far", isSaved ? "far" : "fas");
        });
      }

      if (shareBtn) {
        shareBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const url = `${window.location.origin}/post.html?id=${docId}`;
          if (navigator.share) {
            navigator.share({
              title: data.content?.substring(0, 50) || "Gönderi",
              text: "Bu gönderiye göz at!",
              url: url,
            }).catch(console.error);
          } else {
            navigator.clipboard.writeText(url);
            alert("Bağlantı panoya kopyalandı 📋");
          }
        });
      }
    });
  }, 0);
}


  
    // ⛳️ filterPosts fonksiyonunu global hale getiriyoruz:
    window.filterPosts = function (category) {
      document.querySelectorAll(".category-btn").forEach(btn => btn.classList.remove("active"));
      const activeBtn = Array.from(document.querySelectorAll(".category-btn")).find(btn =>
        btn.textContent.trim() === category);
      if (activeBtn) activeBtn.classList.add("active");
  
      renderPosts(category);
    };

    function generatePostHTML(post, docId, uid) {
  const isLiked = post.likedBy?.includes(uid);
  const isSaved = post.savedBy?.includes(uid);
  const progress = post.progressStep ?? 0;

  return `
    <div class="post-card">
      <div onclick="goToPostDetail('${docId}')" style="cursor: pointer;">
        <div class="post-header">
          <img src="${post.authorPhotoUrl || 'assets/avatars/avatar1.png'}" class="avatar" alt="Avatar">
          <div class="author-info">
            <p class="author-name">${post.authorName || 'Kullanıcı'}</p>
            <p class="post-date">${new Date(post.date?.seconds * 1000).toLocaleString("tr-TR")}</p>
          </div>
        </div>
        <div class="post-content"><p>${post.content || ''}</p></div>
        <div class="step-section">
          <div class="step-title">💡 Eleştir</div>
          <div class="step-body">${progress >= 1 ? (post.step1Note || 'Henüz not girilmemiş.') : 'Henüz bu aşamaya geçilmedi.'}</div>
          <div class="step-title">🛠 Düşündür</div>
          <div class="step-body">${progress >= 2 ? (post.step2Note || 'Henüz not girilmemiş.') : 'Henüz bu aşamaya geçilmedi.'}</div>
          <div class="step-title">✅ Geliştir</div>
          <div class="step-body">${progress >= 3 ? (post.step3Note || 'Henüz not girilmemiş.') : 'Henüz bu aşamaya geçilmedi.'}</div>
        </div>
      </div>

      <!-- Etkileşim butonları - Şık ve çizgisiz -->
      <div class="post-actions">
        <span id="like-${docId}">
          <i class="fa${isLiked ? 's' : 'r'} fa-thumbs-up"></i> ${post.likesCount || 0}
        </span>
        <span onclick="goToPostDetail('${docId}')">
  <i class="far fa-comment"></i> ${post.commentsCount || 0}
</span>
        <span id="save-${docId}">
          <i class="fa${isSaved ? 's' : 'r'} fa-bookmark"></i>
        </span>
        <span id="share-${docId}">
          <i class="fas fa-share"></i>
        </span>
        <span>
          <i class="far fa-eye"></i> ${post.views || 0}
        </span>
      </div>
    </div>
  `;
}
  
    onSnapshot(collection(db, "posts"), snapshot => {
      allPosts = snapshot.docs.map(doc => ({
        docId: doc.id,
        data: doc.data()
      }));
      renderPosts("Tümü");
    });

    window.goToPostDetail = function (docId) {
  window.location.href = `post.html?id=${docId}`;
};

  </script>
  

  <script>
    function updateCharCount() {
      const textarea = document.getElementById("post-content");
      const charCount = textarea.value.length;
      document.getElementById("char-count").textContent = charCount;
  
      const button = document.getElementById("submit-button");
      if (charCount > 0 && charCount <= 280) {
        button.disabled = false;
        button.style.backgroundColor = "#ffa726";
        button.style.cursor = "pointer";
      } else {
        button.disabled = true;
        button.style.backgroundColor = "gray";
        button.style.cursor = "not-allowed";
      }
    }
  </script>  
  
</body>
</html>
