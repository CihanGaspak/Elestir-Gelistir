<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EleÅŸtir-AI Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="chatbot.css">
</head>
<body>
 <main>
  <header>eleÅŸtir-AI</header>

  <div id="chat-container"></div>

  <!-- Kategori SeÃ§ Butonu -->
  <div class="custom-dropdown">
    <button id="dropdown-btn">Kategori seÃ§ <span class="arrow">â–¼</span></button>
    <div id="dropdown-menu" class="dropdown-menu hidden">
      <div onclick="selectCategory('EÄŸitim')">EÄŸitim</div>
      <div onclick="selectCategory('Spor')">Spor</div>
      <div onclick="selectCategory('Tamirat')">Tamirat</div>
      <div onclick="selectCategory('AraÃ§ BakÄ±m')">AraÃ§ BakÄ±m</div>
      <div onclick="selectCategory('SaÄŸlÄ±k')">SaÄŸlÄ±k</div>
      <div onclick="selectCategory('Teknoloji')">Teknoloji</div>
      <div onclick="selectCategory('KiÅŸisel GeliÅŸim')">KiÅŸisel GeliÅŸim</div>
      <div onclick="selectCategory('Sanat')">Sanat</div>
      <div onclick="selectCategory('YazÄ±lÄ±m')">YazÄ±lÄ±m</div>
    </div>
  </div>

    <div id="suggestions" class="suggestions"></div>

  <!-- Mesaj GiriÅŸ AlanÄ± -->
  <div class="input-group">
    <input type="text" id="user-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n...">
    <button onclick="sendMessage()">GÃ¶nder</button>
  </div>

  <!-- ğŸ”„ Yeni KonuÅŸma Butonu -->
<button onclick="resetChat()" class="restart-btn">
  <i class="fas fa-comments"></i> Yeni KonuÅŸma
</button>

</main>


  <script type="module">

window.selectCategory = function (category) {
  dropdownBtn.innerHTML = category + ' <span class="arrow">â–¼</span>';
  dropdownMenu.classList.add('hidden');

  // Kutunun gerÃ§ekten var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
  let suggestionsBox = document.getElementById('suggestions');
  
  // Yoksa tekrar oluÅŸtur ve input alanÄ±ndan hemen Ã¶nce ekle
  if (!suggestionsBox) {
    suggestionsBox = document.createElement('div');
    suggestionsBox.id = 'suggestions';
    suggestionsBox.className = 'suggestions';
    const inputGroup = document.querySelector('.input-group');
    inputGroup.parentNode.insertBefore(suggestionsBox, inputGroup);
  }

  // Ã–nceki butonlarÄ± temizle
  suggestionsBox.innerHTML = "";

  // Yeni butonlarÄ± ekle
  if (categorySuggestions[category]) {
    categorySuggestions[category].forEach(soru => {
      const btn = document.createElement('button');
      btn.textContent = soru;
      btn.className = "suggestion-btn";
      btn.onclick = () => {
        userInput.value = soru;
        sendMessage();
        suggestionsBox.innerHTML = "";
      };
      suggestionsBox.appendChild(btn);
    });
  }
};



const categorySuggestions = {
  "EÄŸitim": [
    "Verimli ders Ã§alÄ±ÅŸmak iÃ§in ne yapmalÄ±yÄ±m?",
    "Ã–ÄŸrenciler iÃ§in zaman yÃ¶netimi nasÄ±l olmalÄ±?",
    "Online eÄŸitim faydalÄ± mÄ±?"
  ],
  "Spor": [
    "Kas yapmak iÃ§in ne yemeliyim?",
    "Evde spor programÄ± Ã¶nerir misin?",
    "Spor sakatlÄ±klarÄ± nasÄ±l Ã¶nlenir?"
  ],
  "Tamirat": [
    "Musluk sÄ±zÄ±ntÄ±sÄ± nasÄ±l giderilir?",
    "Kendi priz tamirimi yapabilir miyim?",
    "Evin duvarÄ±ndaki Ã§atlak tehlikeli mi?"
  ],
  "AraÃ§ BakÄ±m": [
    "YaÄŸ deÄŸiÅŸimi ne sÄ±klÄ±kla yapÄ±lÄ±r?",
    "Araba akÃ¼sÃ¼ nasÄ±l kontrol edilir?",
    "KÄ±ÅŸÄ±n araca nasÄ±l bakÄ±m yapÄ±lÄ±r?"
  ],
  "SaÄŸlÄ±k": [
    "Gripten korunmak iÃ§in ne yapmalÄ±yÄ±m?",
    "Daha enerjik hissetmek iÃ§in ne yemeliyim?",
    "GÃ¶z yorgunluÄŸu nasÄ±l geÃ§er?"
  ],
  "Teknoloji": [
    "Yeni telefon alÄ±rken nelere dikkat etmeliyim?",
    "BilgisayarÄ±m yavaÅŸladÄ±, ne yapabilirim?",
    "Yapay zekÃ¢ hayatÄ±mÄ±zÄ± nasÄ±l etkiliyor?"
  ],
  "KiÅŸisel GeliÅŸim": [
    "Ã–zgÃ¼ven nasÄ±l artÄ±rÄ±lÄ±r?",
    "Sabah rutini neden Ã¶nemlidir?",
    "Hedef belirleme nasÄ±l yapÄ±lÄ±r?"
  ],
  "Sanat": [
    "Resme nereden baÅŸlamalÄ±yÄ±m?",
    "YaratÄ±cÄ±lÄ±ÄŸÄ± artÄ±rmak iÃ§in ne yapÄ±lÄ±r?",
    "Sanat terapisi nedir?"
  ],
  "YazÄ±lÄ±m": [
    "YazÄ±lÄ±m Ã¶ÄŸrenmeye nereden baÅŸlanÄ±r?",
    "Frontend ve Backend farkÄ± nedir?",
    "Hangi programlama dili bana uygun?"
  ]
};

const dropdownBtn = document.getElementById('dropdown-btn');
const dropdownMenu = document.getElementById('dropdown-menu');

dropdownBtn.addEventListener('click', () => {
  dropdownMenu.classList.toggle('hidden');
});

// dÄ±ÅŸarÄ± tÄ±klanÄ±nca kapansÄ±n
document.addEventListener('click', (e) => {
  if (!e.target.closest('.custom-dropdown')) {
    dropdownMenu.classList.add('hidden');
  }
});

// kategori seÃ§ilince butona yaz, ve istersen sorularÄ± gÃ¶ster
function selectCategory(category) {
  dropdownBtn.innerHTML = category + ' <span class="arrow">â–¼</span>';
  dropdownMenu.classList.add('hidden');

  // Ã–neri kutusunu temizle ve yeniden doldur
  const suggestionsBox = document.getElementById('suggestions');
  suggestionsBox.innerHTML = "";

  if (categorySuggestions[category]) {
  categorySuggestions[category].forEach(soru => {
    const btn = document.createElement('button');
    btn.textContent = soru;
    btn.onclick = () => {
      userInput.value = soru;     // input'a yaz
      sendMessage();              // mesajÄ± gÃ¶nder
      suggestionsBox.innerHTML = ""; // Ã¶neri butonlarÄ±nÄ± kaldÄ±r
    };
    suggestionsBox.appendChild(btn);
  });
}
}



    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByrxwGrUPfIFUjsG2Nsv6niu5aM_5v4wM",
      authDomain: "elestir-gelistir.firebaseapp.com",
      projectId: "elestir-gelistir",
      storageBucket: "elestir-gelistir.appspot.com",
      messagingSenderId: "329858460105",
      appId: "1:329858460105:web:0a1940df3d7b57593b6018"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let username = "KullanÄ±cÄ±";
    let photoUrl = "assets/avatars/avatar0.png";

    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const uid = user.uid;
        const docSnap = await getDoc(doc(db, "users", uid));
        if (docSnap.exists()) {
          const data = docSnap.data();
          username = data.username || "KullanÄ±cÄ±";
          photoUrl = data.photoUrl && data.photoUrl.trim() !== ""
            ? (data.photoUrl.startsWith("assets/") ? data.photoUrl : data.photoUrl)
            : "assets/avatars/avatar0.png";
        }

        showWelcomeMessage();

      }
    });

    function showWelcomeMessage() {
  appendMessage("ai", `Merhaba <b>${username}</b>, ben <b>eleÅŸtir-AI ğŸ¤–</b><br>Size nasÄ±l yardÄ±mcÄ± olabilirim?`, "eleÅŸtir-AI ğŸ¤–", "assets/avatars/elestir-AI.png");
}


    function appendMessage(role, text, username = '', photo = '') {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      let content = text;
      let isLong = content.length > 400;
      let shortText = isLong ? content.slice(0, 400) + "..." : content;

      div.innerHTML = `
        <img class="avatar" src="${photo}" alt="avatar">
        <div class="message-content">
          <div class="username">${username}</div>
          <div class="text">${shortText}</div>
          ${isLong ? '<button class="expand-btn">DevamÄ±nÄ± GÃ¶ster</button>' : ''}
        </div>
      `;

      if (isLong) {
        div.querySelector('.expand-btn').addEventListener('click', () => {
          div.querySelector('.text').innerHTML = content;
          div.querySelector('.expand-btn').remove();
        });
      }

      chatContainer.appendChild(div);
      div.scrollIntoView({ behavior: "smooth" });
    }

    async function typeText(element, text) {
      element.innerHTML = '';
      for (let i = 0; i < text.length; i++) {
        element.innerHTML += text[i];
        await new Promise(resolve => setTimeout(resolve, 8)); // HÄ±z ayarÄ± burada
      }
    }

    window.sendMessage = async function () {
      const text = userInput.value.trim();
      if (!text) return;

      // âœ… kategori dropdown'Ä±nÄ± gizle
      document.querySelector('.custom-dropdown')?.classList.add('hidden');


      appendMessage("user", text, username, photoUrl);

      const loading = document.createElement('div');
      loading.className = 'message ai';
      loading.innerHTML = `
        <img class="avatar" src="assets/avatars/elestir-AI.png">
        <div class="message-content">
          <div class="username">EleÅŸtir-AI ğŸ¤–</div>
          <div class="text typing">YazÄ±yor<span class="dot1">.</span><span class="dot2">.</span><span class="dot3">.</span></div>
        </div>
      `;
      chatContainer.appendChild(loading);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      userInput.value = "";

      const identityKeywords = [
        "sen kimsin", "kimsin", "adÄ±n ne", "ismin ne", "adÄ± ne", "sen nesin",
        "senin adÄ±n", "sen kimsin?", "kimsin?", "adÄ±n?"
      ];

      const lowerText = text.toLowerCase();
      const matchesIdentity = identityKeywords.some(keyword => lowerText.includes(keyword));

      if (matchesIdentity) {
        setTimeout(() => {
          loading.innerHTML = `
            <img class="avatar" src="assets/avatars/elestir-AI.png">
            <div class="message-content">
              <div class="username">EleÅŸtir-AI ğŸ¤–</div>
              <div class="text">Ben, <b>Cihan Gaspak</b> tarafÄ±ndan geliÅŸtirilmiÅŸ <b>EleÅŸtir-AI ğŸ¤–</b>'yÄ±m.</div>
            </div>
          `;
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 1000);
        return;
      }

      try {
        const res = await fetch("https://api-wz4bgkt3ua-uc.a.run.app", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
message: `${text}. CevabÄ± kÄ±sa, sade ve teknik bir dille yaz. Samimi ya da sohbet havasÄ±nda olmasÄ±n. Gerekiyorsa maddeler kullan, ama sade olsun. Gereksiz aÃ§Ä±klamalardan kaÃ§Ä±n.`
})


        });

        const data = await res.json();
        console.log("Cevap:", data.reply);

        

if (!data.reply || typeof data.reply !== 'string') {
  throw new Error("API'den geÃ§erli yanÄ±t alÄ±namadÄ±.");
}

const formatted = formatReply(data.reply);
console.log("FormatlanmÄ±ÅŸ:", formatted); // ğŸ‘ˆ Ve buraya

        loading.innerHTML = `
          <img class="avatar" src="assets/avatars/elestir-AI.png">
          <div class="message-content">
            <div class="username">EleÅŸtir-AI ğŸ¤–</div>
            <div class="text"></div>
          </div>
        `;
        
        const textDiv = loading.querySelector('.text');
        textDiv.innerHTML = ''; // Ã¶nce temizle
        textDiv.appendChild(formatted); // DOM elementi olduÄŸu gibi ekle


        chatContainer.scrollTop = chatContainer.scrollHeight;

      } catch (e) {
        loading.innerHTML = `
          <img class="avatar" src="assets/avatars/elestir-AI.png">
          <div class="message-content">
            <div class="username">EleÅŸtir-AI ğŸ¤–</div>
            <div class="text"><i>Hata oluÅŸtu</i></div>
          </div>
        `;
      }
      chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    function formatReply(text) {
    // 1. <br> taglerini gerÃ§ek satÄ±r sonuna Ã§evir
    text = text.replace(/<br\s*\/?>/gi, "\n");
    
    // 2. KapsayÄ±cÄ± div oluÅŸtur ve stil uygula
    const rootDiv = document.createElement("div"); // âœ” en dÄ±ÅŸ div
rootDiv.style.whiteSpace = "pre-wrap";

let container = rootDiv;
    // 3. Metni satÄ±rlara bÃ¶l
    const lines = text.split("\n");
    lines.forEach((line, index) => {
        let pos = 0;
        // 3a. Madde imi kontrolÃ¼ (satÄ±r baÅŸÄ±ndaki -* tespiti)
        const bulletMatch = line.match(/^(\*|-)\s+/);
        if (bulletMatch) {
            // Bullet sembolÃ¼ ekle
            container.appendChild(document.createTextNode("â€¢ "));
            pos = bulletMatch[0].length; // satÄ±r iÃ§indeki baÅŸlangÄ±Ã§ iÅŸaretini atla
        }
        // 3b. SatÄ±r iÃ§ini karakter karakter iÅŸle
        let boldStack = [];  // aÃ§Ä±lan <strong> elementleri yÄ±ÄŸÄ±nÄ± (ihtiyaÃ§ halinde)
        for (; pos < line.length; pos++) {
            const char = line[pos];
            // Bold baÅŸlatma/kapatma kontrolÃ¼ (Markdown yÄ±ldÄ±zlarÄ±)
            if (char === "*") {
                const nextChar = line[pos + 1];
                if (nextChar === "*") {
                    // Ã‡ift yÄ±ldÄ±z yakalandÄ±
                    if (boldStack.length > 0 && boldStack[boldStack.length - 1] === "md-double") {
                        // zaten aÃ§Ä±k bir Ã§ift-yÄ±ldÄ±z bold varsa, kapat
                        boldStack.pop();
                        // Son aÃ§Ä±k <strong> elementini kapat (stack takibiyle)
                        container = container.parentNode;
                    } else {
                        // yeni bir Ã§ift-yÄ±ldÄ±z bold aÃ§
                        const strongElem = document.createElement("strong");
                        container.appendChild(strongElem);
                        // konteks olarak strong'un iÃ§ine metin ekleyeceÄŸimiz iÃ§in container'Ä± gÃ¼ncelle
                        container = strongElem;
                        boldStack.push("md-double");
                    }
                    pos++; // ikinci yÄ±ldÄ±zÄ± da atla
                    continue;
                } else {
                    // Tek yÄ±ldÄ±z yakalandÄ±
                    if (boldStack.length > 0 && boldStack[boldStack.length - 1] === "md-single") {
                        // aÃ§Ä±k bir tek-yÄ±ldÄ±z bold'u kapat
                        boldStack.pop();
                        container = container.parentNode;
                    } else {
                        // yeni tek-yÄ±ldÄ±z bold aÃ§
                        const strongElem = document.createElement("strong");
                        container.appendChild(strongElem);
                        container = strongElem;
                        boldStack.push("md-single");
                    }
                    continue;
                }
            }
            // HTML <b> veya </b> etiket kontrolÃ¼
            if (char === "<") {
                const substring = line.substring(pos).toLowerCase();
                if (substring.startsWith("<b>") || substring.startsWith("<strong>")) {
                    // Bold etiketi aÃ§Ä±lÄ±yor
                    const strongElem = document.createElement("strong");
                    container.appendChild(strongElem);
                    container = strongElem;
                    boldStack.push("html");  // HTML kaynaÄŸÄ±yla aÃ§Ä±lan bold
                    // etiketin tamamÄ±nÄ± atla (<b> 3 karakter, <strong> 8 karakter)
                    pos += substring.startsWith("<strong>") ? 7 : 2;
                    continue;
                }
                if (substring.startsWith("</b>") || substring.startsWith("</strong>")) {
                    // Bold etiketi kapanÄ±yor
                    if (boldStack.length > 0) {
                        boldStack.pop();
                        container = container.parentNode;
                    }
                    // kapanÄ±ÅŸ etiketinin tamamÄ±nÄ± atla (</b> 4 char, </strong> 9 char)
                    pos += substring.startsWith("</strong>") ? 8 : 3;
                    continue;
                }
                if (substring.startsWith("<i>") || substring.startsWith("<em>")) {
                    // Italik aÃ§Ä±lÄ±ÅŸÄ± - isteÄŸe baÄŸlÄ±, benzer mantÄ±kla <em> oluÅŸturulabilir
                    const emElem = document.createElement("em");
                    container.appendChild(emElem);
                    container = emElem;
                    boldStack.push("html-italic");
                    pos += substring.startsWith("<em>") ? 3 : 2;
                    continue;
                }
                if (substring.startsWith("</i>") || substring.startsWith("</em>")) {
                    // Italik kapanÄ±ÅŸÄ±
                    if (boldStack.length > 0) {
                        boldStack.pop();
                        container = container.parentNode;
                    }
                    pos += substring.startsWith("</em>") ? 4 : 3;
                    continue;
                }
                // DiÄŸer durumlarda '<' normal karakter olarak ele alÄ±nacak (etiket deÄŸil)
            }
            // Ã–zel bir durum yoksa, karakteri olduÄŸu gibi metin dÃ¼ÄŸÃ¼mÃ¼ olarak ekle
            container.appendChild(document.createTextNode(char));
        } // for satÄ±r karakter sonu
        // SatÄ±r sonunda, eÄŸer herhangi bir <strong> aÃ§Ä±k kaldÄ±ysa kapatÄ±yoruz:
        while (boldStack.length > 0) {
            boldStack.pop();
            container = container.parentNode;
        }
        // Bir sonraki satÄ±ra geÃ§ (varsa)
        if (index < lines.length - 1) {
            container.appendChild(document.createTextNode("\n"));
        }
    });
    
    return container;
}



    window.quickAsk = function (message) {
  userInput.value = message;
  sendMessage();
}
userInput.addEventListener('input', () => {
  document.getElementById('suggestions')?.replaceChildren();

});

window.resetChat = function () {
  chatContainer.innerHTML = "";
  document.querySelector('.custom-dropdown')?.classList.remove('hidden');
  dropdownBtn.innerHTML = 'Kategori seÃ§ <span class="arrow">â–¼</span>';

  // suggestions kutusu varsa iÃ§ini temizle, yoksa oluÅŸtur
  let suggestionsBox = document.getElementById('suggestions');
  if (!suggestionsBox) {
    suggestionsBox = document.createElement('div');
    suggestionsBox.id = 'suggestions';
    suggestionsBox.className = 'suggestions';
    document.querySelector('main').insertBefore(suggestionsBox, document.querySelector('.input-group'));
  } else {
    suggestionsBox.innerHTML = "";
  }

  showWelcomeMessage();
};


userInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault(); // SatÄ±r atlamayÄ± engelle
    sendMessage();      // MesajÄ± gÃ¶nder
  }
});


  </script>
</body>
</html>
